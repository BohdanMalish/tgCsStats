#!/bin/bash

# –°–∫—Ä–∏–ø—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ–≥–æ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è CS2 Stats Bot
# –í–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è: ./scripts/update_bot.sh

set -e  # –ó—É–ø–∏–Ω–∏—Ç–∏ –ø—Ä–∏ –ø–æ–º–∏–ª—Ü—ñ

echo "üîÑ –ü–æ—á–∞—Ç–æ–∫ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è CS2 Stats Bot..."

# –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ —á–∏ –º–∏ –≤ –ø—Ä–∞–≤–∏–ª—å–Ω—ñ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä—ñ—ó
if [ ! -f "docker-compose.yml" ]; then
    echo "‚ùå –ü–æ–º–∏–ª–∫–∞: docker-compose.yml –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ!"
    echo "–ó–∞–ø—É—Å–∫–∞–π —Å–∫—Ä–∏–ø—Ç –∑ –∫–æ—Ä–µ–Ω–µ–≤–æ—ó –¥–∏—Ä–µ–∫—Ç–æ—Ä—ñ—ó –ø—Ä–æ–µ–∫—Ç—É"
    exit 1
fi

# –°—Ç–≤–æ—Ä—é—î–º–æ backup –±–∞–∑–∏ –¥–∞–Ω–∏—Ö
if [ -f "data/bot_database.db" ]; then
    echo "üíæ –°—Ç–≤–æ—Ä—é—é backup –±–∞–∑–∏ –¥–∞–Ω–∏—Ö..."
    BACKUP_NAME="data/backup_$(date +%Y%m%d_%H%M%S).db"
    cp data/bot_database.db "$BACKUP_NAME"
    echo "‚úÖ Backup —Å—Ç–≤–æ—Ä–µ–Ω–æ: $BACKUP_NAME"
fi

# –ó—É–ø–∏–Ω—è—î–º–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
echo "üõë –ó—É–ø–∏–Ω—è—é –±–æ—Ç–∞..."
docker-compose down

# –û–Ω–æ–≤–ª—é—î–º–æ –∫–æ–¥
echo "üì• –ó–∞–≤–∞–Ω—Ç–∞–∂—É—é –æ–Ω–æ–≤–ª–µ–Ω–Ω—è..."
git fetch origin
git pull origin main

# –ü–µ—Ä–µ–±—É–¥–æ–≤—É—î–º–æ –æ–±—Ä–∞–∑
echo "üî® –ü–µ—Ä–µ–±—É–¥–æ–≤—É—é Docker –æ–±—Ä–∞–∑..."
docker-compose build --no-cache

# –ó–∞–ø—É—Å–∫–∞—î–º–æ –æ–Ω–æ–≤–ª–µ–Ω–∏–π –±–æ—Ç
echo "üöÄ –ó–∞–ø—É—Å–∫–∞—é –æ–Ω–æ–≤–ª–µ–Ω–æ–≥–æ –±–æ—Ç–∞..."
docker-compose up -d

# –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ —Å—Ç–∞—Ç—É—Å
echo "üîç –ü–µ—Ä–µ–≤—ñ—Ä—è—é —Å—Ç–∞—Ç—É—Å..."
sleep 5
if docker-compose ps | grep -q "Up"; then
    echo "‚úÖ –ë–æ—Ç —É—Å–ø—ñ—à–Ω–æ –æ–Ω–æ–≤–ª–µ–Ω–æ —Ç–∞ –∑–∞–ø—É—â–µ–Ω–æ!"
    
    # –ü–æ–∫–∞–∑—É—î–º–æ –ª–æ–≥–∏ –æ—Å—Ç–∞–Ω–Ω—ñ—Ö 20 —Ä—è–¥–∫—ñ–≤
    echo "üìã –û—Å—Ç–∞–Ω–Ω—ñ –ª–æ–≥–∏:"
    docker-compose logs --tail=20 cs2-stats-bot
else
    echo "‚ùå –ü–æ–º–∏–ª–∫–∞! –ë–æ—Ç –Ω–µ –∑–∞–ø—É—Å—Ç–∏–≤—Å—è."
    echo "–ü–µ—Ä–µ–≤—ñ—Ä –ª–æ–≥–∏: docker-compose logs cs2-stats-bot"
    exit 1
fi

echo "üéâ –û–Ω–æ–≤–ª–µ–Ω–Ω—è –∑–∞–≤–µ—Ä—à–µ–Ω–æ!"
